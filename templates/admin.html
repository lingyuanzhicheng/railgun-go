<!doctype html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Railgun 管理</title>
    <link rel="icon" href="static/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
      :root {
        --primary-color: #4a6cf7;
        --secondary-color: #f5f7ff;
        --border-color: #e1e5ee;
        --text-muted: #6c757d;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f9fa;
        color: #333;
        padding: 0;
        margin: 0;
      }

      .topbar {
        background-color: white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        padding: 1rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .brand {
        font-weight: 600;
        font-size: 1.5rem;
        color: var(--primary-color);
      }

      .menus {
        display: flex;
        gap: 0.5rem;
      }

      .menu-btn {
        border-radius: 20px;
        padding: 0.5rem 1rem;
        font-weight: 500;
        border: 1px solid var(--border-color);
        background-color: white;
        color: var(--text-muted);
        transition: all 0.2s ease;
      }

      .menu-btn:hover {
        background-color: var(--secondary-color);
        color: var(--primary-color);
      }

      .menu-btn.active {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      .logout-btn {
        border-radius: 20px;
        padding: 0.4rem 1rem;
        font-weight: 500;
      }

      .content-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
      }

      .panel {
        display: none;
        animation: fadeIn 0.3s ease-in-out;
      }

      .panel.active {
        display: block;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        margin-bottom: 1.5rem;
      }

      .card-header {
        background-color: white;
        border-bottom: 1px solid var(--border-color);
        border-radius: 12px 12px 0 0 !important;
        padding: 1rem 1.5rem;
        font-weight: 600;
      }

      .preview-box {
        max-height: 60vh;
        overflow: auto;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        background-color: #f8f9fa;
        font-family: monospace;
        font-size: 0.9rem;
      }

      .input-group {
        margin-bottom: 1rem;
      }

      .form-control {
        border-radius: 8px;
        border: 1px solid var(--border-color);
        padding: 0.6rem 1rem;
      }

      .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(74, 108, 247, 0.1);
      }

      .btn {
        border-radius: 8px;
        font-weight: 500;
        padding: 0.6rem 1.2rem;
        white-space: nowrap;
      }

      .btn-group .btn {
        min-width: 120px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
      }

      .btn-primary:hover {
        background-color: #3a5bd9;
        border-color: #3a5bd9;
      }

      .list-group-item {
        border: none;
        border-bottom: 1px solid var(--border-color);
        padding: 1rem 1.5rem;
      }

      .list-group-item:last-child {
        border-bottom: none;
      }

      .badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-weight: 500;
      }

      .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #333;
      }
    </style>
  </head>
  <body>
    <!-- 管理界面 -->
    <div id="adminContainer">
      <div class="topbar">
        <div class="brand">Railgun</div>
        <div class="menus">
          <button class="menu-btn active" data-target="proc"><i class="bi bi-gear"></i> 进程配置</button>
          <button class="menu-btn" data-target="uuid"><i class="bi bi-key"></i> UUID配置</button>
          <button class="menu-btn" data-target="workers"><i class="bi bi-cloud"></i> Workers配置</button>
          <button class="menu-btn" data-target="proxy"><i class="bi bi-shield"></i> Proxy配置</button>
          <button class="menu-btn" data-target="cdn"><i class="bi bi-globe"></i> CDN配置</button>
        </div>
        <div>
          <button id="logoutBtn" class="btn btn-sm btn-outline-danger logout-btn"><i class="bi bi-box-arrow-right"></i> 退出登录</button>
        </div>
      </div>

      <div class="content-container">
      <div id="proc" class="panel active">
        <div class="card">
          <div class="card-header">
            <i class="bi bi-gear me-2"></i>进程配置
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="section-title">AuthKey 配置</div>
                <div class="input-group mb-3">
                  <input id="authkeyInputSettings" type="password" class="form-control" placeholder="输入新的AuthKey">
                  <button id="saveAuthKey" class="btn btn-primary">保存</button>
                </div>

                <div class="section-title mt-4">定时任务设置</div>
                <div class="row mb-3">
                  <div class="col-6">

                    <div class="form-check form-switch mb-2">
                      <input class="form-check-input" type="checkbox" id="uuidSyncEnabled">
                      <label class="form-check-label" for="uuidSyncEnabled">UUID同步</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                      <input class="form-check-input" type="checkbox" id="cdnipSyncEnabled">
                      <label class="form-check-label" for="cdnipSyncEnabled">CDNIP同步</label>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="form-check form-switch mb-2">
                      <input class="form-check-input" type="checkbox" id="proxyipSyncEnabled">
                      <label class="form-check-label" for="proxyipSyncEnabled">ProxyIP同步</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                      <input class="form-check-input" type="checkbox" id="proxyhttpSyncEnabled">
                      <label class="form-check-label" for="proxyhttpSyncEnabled">ProxyHTTP同步</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                      <input class="form-check-input" type="checkbox" id="proxysock5SyncEnabled">
                      <label class="form-check-label" for="proxysock5SyncEnabled">ProxySock5同步</label>
                    </div>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="cronExpression" class="form-label">Cron表达式</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="cronExpression" placeholder="0 0 2 * * *">
                    <button class="btn btn-primary" id="saveCronSettings">保存</button>
                  </div>
                  <div class="form-text" id="nextRunInfo">预计下次执行时间：未设置</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="section-title">系统日志</div>
                <div class="preview-box" id="logbox" style="height: 300px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; padding: 10px;">等待日志加载...</div>
                <div class="d-flex justify-content-end mt-2">
                  <button id="clearLogs" class="btn btn-sm btn-outline-secondary">清空日志</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="uuid" class="panel">
        <div class="card">
          <div class="card-header">
            <i class="bi bi-key me-2"></i>UUID 配置
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3 input-group">
                  <input id="newUuid" class="form-control" placeholder="输入 uuid...">
                  <button id="addUuid" class="btn btn-success">添加</button>
                </div>
                <ul id="uuidList" class="list-group"></ul>
              </div>
              <div class="col-md-6">
                <div class="section-title">UUID源</div>
                <div id="workersList" class="list-group"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="workers" class="panel">
        <div class="card">
          <div class="card-header">
            <i class="bi bi-cloud me-2"></i>Workers 配置
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <div class="input-group mb-2">
                    <input id="newWorkerUrl" class="form-control" placeholder="workers 链接">
                  </div>
                  <div class="input-group mb-2">
                    <input id="newWorkerApikey" class="form-control" placeholder="apikey">
                    <button id="addWorker" class="btn btn-success">添加</button>
                  </div>
                </div>
                <div id="workersEditList" class="list-group"></div>
              </div>
              <div class="col-md-6">
                <div class="section-title">Workers 配置详情</div>
                <div class="preview-box" id="workersRaw"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="proxy" class="panel">
        <div class="card">
          <div class="card-header">
            <i class="bi bi-shield me-2"></i>Proxy 配置
          </div>
          <div class="card-body">
            <!-- 顶部按钮组 -->
            <div class="d-flex mb-3">
              <div class="btn-group me-3" role="group">
                <button type="button" class="btn btn-primary active" id="proxyIpBtn">Proxy IP</button>
                <button type="button" class="btn btn-outline-primary" id="proxyHttpBtn">Proxy HTTP</button>
                <button type="button" class="btn btn-outline-primary" id="proxySock5Btn">Proxy Sock5</button>
              </div>
              <div class="input-group flex-grow-1">
                <input id="proxySyncUrl" class="form-control" placeholder="同步源">
                <button id="saveProxySync" class="btn btn-primary">保存</button>
                <button id="syncProxy" class="btn btn-secondary">同步</button>
              </div>
            </div>

            <!-- 内容区域 -->
            <div class="row">
              <div class="col-12">
                <div class="preview-box" id="proxyRaw" style="height: 500px;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="cdn" class="panel">
        <div class="card">
          <div class="card-header">
            <i class="bi bi-globe me-2"></i>CDN 配置
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="section-title">CDN Domain 配置</div>
                <div class="mb-3 input-group">
                  <input id="newCdnDomain" class="form-control" placeholder="输入 CDN 域名...">
                  <button id="addCdnDomain" class="btn btn-success">添加</button>
                </div>
                <div class="mb-3 input-group">
                  <input id="newCdnDomainOption" class="form-control" placeholder="输入 CDN 域名备注...">
                </div>
                <ul id="cdnDomainList" class="list-group"></ul>
              </div>
              <div class="col-md-6">
                <div class="section-title">CDN IP 同步配置</div>
                <div class="input-group mb-3">
                  <input id="cdnSyncUrl" class="form-control" placeholder="cdnip 同步源">
                  <button id="saveCdnSync" class="btn btn-primary">保存</button>
                  <button id="syncCdn" class="btn btn-secondary">同步</button>
                </div>
                <div class="preview-box" id="cdnRaw"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
    </div> <!-- adminContainer -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // 检查登录状态
      // 页面加载时加载数据
      window.addEventListener('load', loadData);

      // 处理退出登录
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
          await fetch('/logout', {
            method: 'GET',
            credentials: 'include'
          });

          // 重定向到登录页面
          window.location.href = '/auth';
        } catch (error) {
          console.error('退出登录失败:', error);
          alert('退出登录失败: ' + error.message);
        }
      });
      document.querySelectorAll('.menu-btn').forEach(b=>b.addEventListener('click',e=>{
        document.querySelectorAll('.menu-btn').forEach(btn=>btn.classList.remove('active'));
        e.target.classList.add('active');

        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        document.getElementById(e.target.dataset.target).classList.add('active');
      }));

      document.getElementById('logoutBtn').addEventListener('click', () => {
        window.location.href = '/logout';
      });

      document.getElementById('saveAuthKey').addEventListener('click', async ()=>{
        const v=document.getElementById('authkeyInputSettings').value;
        if (!v) {
          alert('请输入新的AuthKey');
          return;
        }
        await fetch('/api/save_authkey',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({authkey:v})});
        alert('AuthKey已更新，请重新登录');
        // 清空session cookie
        document.cookie = 'session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        // 重定向到登录页面
        window.location.href = '/';
      });

      // 定时任务设置
      document.getElementById('saveCronSettings').addEventListener('click', async () => {

        const cronExpression = document.getElementById('cronExpression').value;
        const uuidSyncEnabled = document.getElementById('uuidSyncEnabled').checked;
        const cdnipSyncEnabled = document.getElementById('cdnipSyncEnabled').checked;
        const proxyipSyncEnabled = document.getElementById('proxyipSyncEnabled').checked;
        const proxyhttpSyncEnabled = document.getElementById('proxyhttpSyncEnabled').checked;
        const proxysock5SyncEnabled = document.getElementById('proxysock5SyncEnabled').checked;

        const btn = document.getElementById('saveCronSettings');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>保存中...';

        try {
          await fetch('/api/save_cron_settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              cron_expression: cronExpression,
              uuid_sync_enabled: uuidSyncEnabled,
              cdnip_sync_enabled: cdnipSyncEnabled,
              proxyip_sync_enabled: proxyipSyncEnabled,
              proxyhttp_sync_enabled: proxyhttpSyncEnabled,
              proxysock5_sync_enabled: proxysock5SyncEnabled
            })
          });

          // 更新下次执行时间
          await updateNextRunTime();
          alert('定时任务设置已保存');
        } catch (error) {
          console.error('保存定时任务设置失败:', error);
          alert('保存定时任务设置失败: ' + error.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      });

      // 更新下次执行时间
      async function updateNextRunTime() {
        try {
          const response = await fetch('/api/get_cron_next');
          if (response.ok) {
            const data = await response.json();
            if (data.next_run === "未启用" || data.next_run === "表达式错误" || data.next_run === "表达式格式错误") {
              document.getElementById('nextRunInfo').textContent = `预计下次执行时间：${data.next_run}`;
            } else {
              document.getElementById('nextRunInfo').textContent = `预计下次执行时间：${data.next_run}`;
            }
          }
        } catch (error) {
          console.error('获取下次执行时间失败:', error);
          document.getElementById('nextRunInfo').textContent = '预计下次执行时间：获取失败';
        }
      }

      // 为各个开关添加事件监听，使其立即生效
      ['uuidSyncEnabled', 'cdnipSyncEnabled', 'proxyipSyncEnabled', 'proxyhttpSyncEnabled', 'proxysock5SyncEnabled'].forEach(id => {
        document.getElementById(id).addEventListener('change', updateCronSwitches);
      });

      // 更新cron开关设置
      async function updateCronSwitches() {
        const uuidSyncEnabled = document.getElementById('uuidSyncEnabled').checked;
        const cdnipSyncEnabled = document.getElementById('cdnipSyncEnabled').checked;
        const proxyipSyncEnabled = document.getElementById('proxyipSyncEnabled').checked;
        const proxyhttpSyncEnabled = document.getElementById('proxyhttpSyncEnabled').checked;
        const proxysock5SyncEnabled = document.getElementById('proxysock5SyncEnabled').checked;

        try {
          // 获取当前的cron表达式
          let cronExpression = document.getElementById('cronExpression').value || "0 0/10 * * * *";

          await fetch('/api/save_cron_settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              cron_expression: cronExpression,
              uuid_sync_enabled: uuidSyncEnabled,
              cdnip_sync_enabled: cdnipSyncEnabled,
              proxyip_sync_enabled: proxyipSyncEnabled,
              proxyhttp_sync_enabled: proxyhttpSyncEnabled,
              proxysock5_sync_enabled: proxysock5SyncEnabled
            })
          });

          // 更新下次执行时间
          await updateNextRunTime();
        } catch (error) {
          console.error('更新定时任务设置失败:', error);
        }
      }

      async function loadData(){
        const r=await fetch('/api/data');
        if(r.ok){
          const d=await r.json();
          document.getElementById('cdnSyncUrl').value = d.cdnipsync || '';
          document.getElementById('proxySyncUrl').value = d.proxyipsync || '';

          // 加载定时任务设置
          document.getElementById('cronExpression').value = d.cron_expression || '';
          document.getElementById('uuidSyncEnabled').checked = d.uuid_sync_enabled || false;
          document.getElementById('cdnipSyncEnabled').checked = d.cdnip_sync_enabled || false;
          document.getElementById('proxyipSyncEnabled').checked = d.proxyip_sync_enabled || false;
          document.getElementById('proxyhttpSyncEnabled').checked = d.proxyhttp_sync_enabled || false;
          document.getElementById('proxysock5SyncEnabled').checked = d.proxysock5_sync_enabled || false;

          // 更新下次执行时间
          await updateNextRunTime();
        }
      }

      // CDN IP同步功能
      document.getElementById('saveCdnSync').addEventListener('click', async ()=>{
        const url = document.getElementById('cdnSyncUrl').value;
        await fetch('/api/save_cdnipsync',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({cdnipsync:url})});
      });

      document.getElementById('syncCdn').addEventListener('click', async ()=>{
        const syncBtn = document.getElementById('syncCdn');
        const originalText = syncBtn.innerHTML;
        syncBtn.disabled = true;
        syncBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>同步中...';

        try {
          await fetch('/api/sync_cdnip',{method:'POST'});
          await loadCdnIp();
          alert('同步成功');
        } catch (error) {
          console.error('同步出错:', error);
          alert('同步出错: ' + error.message);
        } finally {
          syncBtn.disabled = false;
          syncBtn.innerHTML = originalText;
        }
      });

      async function loadCdnIp() {
        const r = await fetch('/api/cdnip');
        if(r.ok) {
          const data = await r.json();
          document.getElementById('cdnRaw').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        }
      }

      // 当前选中的Proxy类型
      let currentProxyType = 'ip';

      // Proxy类型按钮切换逻辑
      document.getElementById('proxyIpBtn').addEventListener('click', async () => {
        setActiveProxyButton('proxyIpBtn');
        currentProxyType = 'ip';
        await loadProxyData();
      });

      document.getElementById('proxyHttpBtn').addEventListener('click', async () => {
        setActiveProxyButton('proxyHttpBtn');
        currentProxyType = 'http';
        await loadProxyData();
      });

      document.getElementById('proxySock5Btn').addEventListener('click', async () => {
        setActiveProxyButton('proxySock5Btn');
        currentProxyType = 'sock5';
        await loadProxyData();
      });

      // 设置活动按钮样式
      function setActiveProxyButton(activeId) {
        document.querySelectorAll('#proxy .btn-group button').forEach(btn => {
          btn.classList.remove('btn-primary', 'active');
          btn.classList.add('btn-outline-primary');
        });

        const activeBtn = document.getElementById(activeId);
        activeBtn.classList.remove('btn-outline-primary');
        activeBtn.classList.add('btn-primary', 'active');
      }

      // 加载不同类型的Proxy数据
      async function loadProxyData() {
        // 确保根据当前选择的类型加载正确的数据
        console.log('Loading proxy data for type:', currentProxyType);

        // 显示加载中状态
        document.getElementById('proxyRaw').innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border" role="status"><span class="visually-hidden">加载中...</span></div></div>';

        let endpoint;
        let syncField;

        switch(currentProxyType) {
          case 'ip':
            endpoint = '/api/proxyip';
            syncField = 'proxyipsync';
            break;
          case 'http':
            endpoint = '/api/proxyhttp';
            syncField = 'proxyhttpsync';
            break;
          case 'sock5':
            endpoint = '/api/proxysock5';
            syncField = 'proxysock5sync';
            break;
        }

        try {
          // 更新同步源URL
          const r = await fetch('/api/data');
          if(r.ok) {
            const data = await r.json();
            document.getElementById('proxySyncUrl').value = data[syncField] || '';
          }

          // 加载对应的数据
          console.log('Fetching data from endpoint:', endpoint);
          const dataResp = await fetch(endpoint);
          if(dataResp.ok) {
            const data = await dataResp.json();
            console.log('Successfully loaded data for type:', currentProxyType);
            document.getElementById('proxyRaw').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
          } else {
            console.error('Failed to load data for type:', currentProxyType, 'Status:', dataResp.status);
            document.getElementById('proxyRaw').innerHTML = '<pre>加载失败，请重试。状态码: ' + dataResp.status + '</pre>';
          }
        } catch (error) {
          console.error('Error loading proxy data:', error);
          document.getElementById('proxyRaw').innerHTML = '<pre>加载出错: ' + error.message + '</pre>';
        }
      }

      // Proxy同步功能
      document.getElementById('saveProxySync').addEventListener('click', async ()=>{
        const url = document.getElementById('proxySyncUrl').value;
        let syncField;

        switch(currentProxyType) {
          case 'ip':
            syncField = 'proxyipsync';
            break;
          case 'http':
            syncField = 'proxyhttpsync';
            break;
          case 'sock5':
            syncField = 'proxysock5sync';
            break;
        }

        await fetch('/api/save_' + syncField,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({[syncField]:url})});
      });

      document.getElementById('syncProxy').addEventListener('click', async ()=>{
        const syncUrl = document.getElementById('proxySyncUrl').value;
        if (!syncUrl) {
          alert('请先输入同步URL');
          return;
        }

        console.log('Starting sync for type:', currentProxyType, 'with URL:', syncUrl);

        let fileName;

        switch(currentProxyType) {
          case 'ip':
            fileName = 'proxyip.json';
            break;
          case 'http':
            fileName = 'proxyhttp.json';
            break;
          case 'sock5':
            fileName = 'proxysock5.json';
            break;
        }

        try {
          // 显示加载状态
          const syncBtn = document.getElementById('syncProxy');
          const originalText = syncBtn.innerHTML;
          syncBtn.disabled = true;
          syncBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>同步中...';

          // 直接从URL获取JSON数据并保存到对应的文件
          console.log('Downloading JSON from URL and saving to file:', fileName);

          // 直接下载JSON文件内容，不做任何转换
          console.log('Directly downloading JSON from URL:', syncUrl);

          // 使用现有的API端点，但修改请求参数确保直接下载
          let apiEndpoint;
          switch(currentProxyType) {
            case 'ip':
              apiEndpoint = '/api/sync_proxyip';
              break;
            case 'http':
              apiEndpoint = '/api/sync_proxyhttp';
              break;
            case 'sock5':
              apiEndpoint = '/api/sync_proxysock5';
              break;
          }

          console.log('Using API endpoint:', apiEndpoint);

          // 直接下载文件并替换到指定位置
          console.log('Downloading file from URL:', syncUrl);

          // 获取目标文件名 - 变量已在前面声明，这里只赋值
          switch(currentProxyType) {
            case 'ip':
              fileName = 'proxyip.json';
              break;
            case 'http':
              fileName = 'proxyhttp.json';
              break;
            case 'sock5':
              fileName = 'proxysock5.json';
              break;
          }

          console.log('Target file name:', fileName);

          // 使用通用API端点，传递文件名和URL
          const response = await fetch('/api/download_file', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              url: syncUrl,
              fileName: fileName
            })
          });

          if (response.ok) {
            console.log('Sync successful, reloading data for type:', currentProxyType);
            // 同步成功后加载数据
            await loadProxyData();
            alert('同步成功');
          } else {
            console.error('Sync failed with status:', response.status);
            alert('同步失败: ' + await response.text());
          }

          // 恢复按钮状态
          syncBtn.disabled = false;
          syncBtn.innerHTML = originalText;
        } catch (error) {
          console.error('同步出错:', error);
          alert('同步出错: ' + error.message);

          // 恢复按钮状态
          const syncBtn = document.getElementById('syncProxy');
          syncBtn.disabled = false;
          syncBtn.innerHTML = '同步';
        }
      });

      async function loadProxyIp() {
        const r = await fetch('/api/proxyip');
        if(r.ok) {
          const data = await r.json();
          document.getElementById('proxyRaw').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';

          // 更新Proxy IP列表
          const list = document.getElementById('proxyIpList');
          list.innerHTML = '';

          // 使用固定高度，确保列表正常显示
          list.style.height = '400px';
          list.style.overflowY = 'auto';
          list.style.marginBottom = '0';

          // 确保列表项能正常显示
          list.style.display = 'block';

          data.forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex align-items-center';
            li.style.borderRadius = '12px';
            li.style.marginBottom = '8px';
            li.style.border = '1px solid var(--border-color)';
            li.style.padding = '10px 15px';

            // 创建固定宽度的字段容器
            const container = document.createElement('div');
            container.className = 'd-flex w-100';

            // IP字段 - 固定宽度
            const ipContainer = document.createElement('div');
            ipContainer.style.width = '140px';
            ipContainer.style.marginRight = '15px';
            ipContainer.style.whiteSpace = 'nowrap';
            ipContainer.style.overflow = 'hidden';
            ipContainer.style.textOverflow = 'ellipsis';
            ipContainer.textContent = item.ip;

            // Port字段 - 固定宽度
            const portContainer = document.createElement('div');
            portContainer.style.width = '80px';
            portContainer.style.marginRight = '15px';
            portContainer.textContent = item.port;

            // Code字段 - 固定宽度
            const codeContainer = document.createElement('div');
            codeContainer.style.width = '60px';
            codeContainer.style.marginRight = '15px';
            codeContainer.textContent = item.code;

            // ASN字段 - 占用剩余空间
            const asnContainer = document.createElement('div');
            asnContainer.className = 'flex-grow-1 text-muted';
            asnContainer.style.whiteSpace = 'nowrap';
            asnContainer.style.overflow = 'hidden';
            asnContainer.style.textOverflow = 'ellipsis';
            asnContainer.textContent = item.asn || '无ASN信息';

            container.appendChild(ipContainer);
            container.appendChild(portContainer);
            container.appendChild(codeContainer);
            container.appendChild(asnContainer);

            li.appendChild(container);
            list.appendChild(li);
          });
        }
      }

      // UUID管理功能
      document.getElementById('addUuid').addEventListener('click', async ()=>{
        const uuid = document.getElementById('newUuid').value;
        if(!uuid) {
          return;
        }

        const btn = document.getElementById('addUuid');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>添加中...';

        if (currentUuidSource === 'local') {
          // 本地操作
          await fetch('/api/uuids',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({uuid:uuid, statu:true})
          });
        } else {
          // 远程操作
          try {
            let url = currentUuidSource;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
              url = 'https://' + url;
            }

            await fetch(url + '/sync', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + currentWorkerApikey,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                action: 'put',
                uuid: uuid,
                value: "true"
              })
            });
          } catch (error) {
            alert('添加远程UUID失败: ' + error.message);
            console.error('Error adding remote UUID:', error);
          }
        }

        document.getElementById('newUuid').value = '';
        await loadUuidsFromSource();

        btn.disabled = false;
        btn.innerHTML = originalText;
      });

      // 当前UUID源类型：'local' 或远程worker URL
      let currentUuidSource = 'local';
      let currentWorkerApikey = '';

      // 加载本地UUID
      async function loadLocalUuids() {
        currentUuidSource = 'local';
        currentWorkerApikey = '';
        await loadUuidsFromSource();

        // 更新按钮状态 - 确保只有一个载入源
        document.querySelectorAll('#workersList button').forEach(btn => {
          if (btn.id !== 'loadLocalUuidBtn' && (btn.innerHTML.includes('载入UUID') || btn.innerHTML.includes('已载入源'))) {
            btn.innerHTML = '<i class="bi bi-download"></i> 载入UUID';
            btn.classList.remove('btn-warning');
            btn.classList.add('btn-success');
          }
        });

        const localBtn = document.getElementById('loadLocalUuidBtn');
        localBtn.innerHTML = '<i class="bi bi-download"></i> 已载入源';
        localBtn.classList.remove('btn-success');
        localBtn.classList.add('btn-warning');
      }

      // 加载远程UUID
      async function loadRemoteUuids(workerUrl, apikey) {
        try {
          console.log('准备加载远程UUID，worker:', workerUrl);

          const response = await fetch('/api/get_remote_uuids', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({workerURL: workerUrl})
          });

          console.log('响应状态:', response.status);
          console.log('响应头 Content-Type:', response.headers.get('Content-Type'));

          if (!response.ok) {
            const errorText = await response.text();
            console.error('响应错误内容:', errorText);
            throw new Error('获取远程UUID失败: ' + response.status + ' - ' + errorText);
          }

          const responseText = await response.text();
          console.log('响应文本:', responseText);

          let result;
          try {
            result = JSON.parse(responseText);
          } catch (e) {
            console.error('解析JSON失败:', e);
            throw new Error('解析响应JSON失败: ' + e.message);
          }

          currentUuidSource = workerUrl;
          currentWorkerApikey = apikey;

          // 显示远程UUID列表
          const list = document.getElementById('uuidList');
          list.innerHTML = '';

          // 适配Cloudflare Workers返回的格式
          const rawData = Array.isArray(result) ? result : (result.data || []);

          // 转换Cloudflare Workers返回的格式为我们需要的格式
          const data = rawData.map(item => {
            return {
              uuid: item.uuid,
              statu: item.value === 'true' || item.value === true
            };
          });

          data.forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.style.borderRadius = '12px';
            li.style.marginBottom = '8px';
            li.style.border = '1px solid var(--border-color)';

            const uuidText = document.createElement('span');
            uuidText.className = 'flex-grow-1';
            uuidText.textContent = item.uuid;

            const statusBtn = document.createElement('button');
            statusBtn.className = 'btn btn-sm me-2 ' + (item.statu ? 'btn-success' : 'btn-outline-secondary');
            statusBtn.innerHTML = '<i class="bi ' + (item.statu ? 'bi-check-circle' : 'bi-x-circle') + '"></i> ' + (item.statu ? '启用' : '禁用');
            statusBtn.addEventListener('click', async () => {
              const originalText = statusBtn.innerHTML;
              statusBtn.disabled = true;
              statusBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>更新中...';

              const newStatus = !item.statu;

              try {
                console.log('更新远程UUID状态，Worker URL:', workerUrl);
                console.log('API Key:', currentWorkerApikey ? '已设置' : '未设置');
                console.log('UUID:', item.uuid);
                console.log('新状态:', newStatus);

                const requestBody = JSON.stringify({
                  workerURL: workerUrl,
                  action: 'put',
                  uuid: item.uuid,
                  value: newStatus ? "true" : "false"
                });
                console.log('请求体:', requestBody);

                try {
                  const response = await fetch('/api/remote_uuid_action', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: requestBody
                  });

                  console.log('响应状态:', response.status);
                  console.log('响应头:', response.headers);

                  if (!response.ok) {
                    const errorText = await response.text();
                    console.error('响应错误内容:', errorText);
                    throw new Error('更新远程UUID状态失败: ' + response.status + ' - ' + errorText);
                  }

                  // 重新加载远程UUID列表
                  await loadRemoteUuids(workerUrl, apikey);
                } catch (fetchError) {
                  console.error('Fetch错误:', fetchError);
                  console.error('错误名称:', fetchError.name);
                  console.error('错误消息:', fetchError.message);

                  // 如果是网络错误，提供更具体的错误信息
                  if (fetchError.name === 'TypeError' && fetchError.message.includes('Failed to fetch')) {
                    throw new Error('网络连接失败，请检查URL是否正确: ' + url);
                  }

                  throw fetchError;
                }
              } catch (error) {
                alert('更新远程UUID状态失败: ' + error.message);
                console.error('Error updating remote UUID status:', error);
              }

              statusBtn.disabled = false;
              statusBtn.innerHTML = originalText;
            });

            const delBtn = document.createElement('button');
            delBtn.className = 'btn btn-sm btn-outline-danger';
            delBtn.innerHTML = '<i class="bi bi-trash"></i> 删除';
            delBtn.addEventListener('click', async () => {
              if(confirm('确定要删除这个UUID吗？')) {
                const originalText = delBtn.innerHTML;
                delBtn.disabled = true;
                delBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>删除中...';

                try {
                  console.log('删除远程UUID，Worker URL:', workerUrl);
                  console.log('API Key:', currentWorkerApikey ? '已设置' : '未设置');
                  console.log('UUID:', item.uuid);

                  const requestBody = JSON.stringify({
                    workerURL: workerUrl,
                    action: 'delete',
                    uuid: item.uuid
                  });
                  console.log('请求体:', requestBody);

                  try {
                    const response = await fetch('/api/remote_uuid_action', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json'
                      },
                      body: requestBody
                    });

                    console.log('响应状态:', response.status);
                    console.log('响应头:', response.headers);

                    if (!response.ok) {
                      const errorText = await response.text();
                      console.error('响应错误内容:', errorText);
                      throw new Error('删除远程UUID失败: ' + response.status + ' - ' + errorText);
                    }

                    // 重新加载远程UUID列表
                    await loadRemoteUuids(workerUrl, apikey);
                  } catch (fetchError) {
                    console.error('Fetch错误:', fetchError);
                    console.error('错误名称:', fetchError.name);
                    console.error('错误消息:', fetchError.message);

                    // 如果是网络错误，提供更具体的错误信息
                    if (fetchError.name === 'TypeError' && fetchError.message.includes('Failed to fetch')) {
                      throw new Error('网络连接失败，请检查URL是否正确: ' + url);
                    }

                    throw fetchError;
                  }
                } catch (error) {
                  alert('删除远程UUID失败: ' + error.message);
                  console.error('Error deleting remote UUID:', error);
                }

                delBtn.disabled = false;
                delBtn.innerHTML = originalText;
              }
            });

            li.appendChild(uuidText);
            li.appendChild(statusBtn);
            li.appendChild(delBtn);

            list.appendChild(li);
          });
        } catch (error) {
          alert('加载远程UUID失败: ' + error.message);
          console.error('Error loading remote UUIDs:', error);
        }
      }

      // 从当前源加载UUID
      async function loadUuidsFromSource() {
        let data;

        if (currentUuidSource === 'local') {
          // 加载本地UUID
          const r = await fetch('/api/uuids');
          if (r.ok) {
            data = await r.json();
          } else {
            alert('加载本地UUID失败');
            return;
          }
        } else {
          // 加载远程UUID
          try {
            // 确保URL格式正确
            let url = currentUuidSource;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
              url = 'https://' + url;
            }

            const response = await fetch(url + '/sync', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + currentWorkerApikey,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({action: 'list'})
            });

            if (!response.ok) {
              throw new Error('获取远程UUID失败: ' + response.status);
            }

            const result = await response.json();
            data = result.data || [];
          } catch (error) {
            alert('加载远程UUID失败: ' + error.message);
            console.error('Error loading remote UUIDs:', error);
            return;
          }
        }

        // 显示UUID列表
        const list = document.getElementById('uuidList');
        list.innerHTML = '';

        data.forEach(item => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.style.borderRadius = '12px';
          li.style.marginBottom = '8px';
          li.style.border = '1px solid var(--border-color)';

          const uuidText = document.createElement('span');
          uuidText.className = 'flex-grow-1';
          uuidText.textContent = item.uuid;

          const statusBtn = document.createElement('button');
          statusBtn.className = 'btn btn-sm me-2 ' + (item.statu ? 'btn-success' : 'btn-outline-secondary');
          statusBtn.innerHTML = '<i class="bi ' + (item.statu ? 'bi-check-circle' : 'bi-x-circle') + '"></i> ' + (item.statu ? '启用' : '禁用');
          statusBtn.addEventListener('click', async () => {
            const originalText = statusBtn.innerHTML;
            statusBtn.disabled = true;
            statusBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>更新中...';

            const newStatus = !item.statu;

            if (currentUuidSource === 'local') {
              // 本地操作
              await fetch('/api/uuid',{
                method:'PUT',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({uuid:item.uuid, statu:newStatus})
              });
            } else {
              // 远程操作
              try {
                let url = currentUuidSource;
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                  url = 'https://' + url;
                }

                await fetch(url + '/sync', {
                  method: 'POST',
                  headers: {
                    'Authorization': 'Bearer ' + currentWorkerApikey,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    action: 'put',
                    uuid: item.uuid,
                    value: newStatus.toString()
                  })
                });
              } catch (error) {
                alert('更新远程UUID状态失败: ' + error.message);
                console.error('Error updating remote UUID status:', error);
              }
            }

            await loadUuidsFromSource();
            statusBtn.disabled = false;
            statusBtn.innerHTML = originalText;
          });

          const delBtn = document.createElement('button');
          delBtn.className = 'btn btn-sm btn-outline-danger';
          delBtn.innerHTML = '<i class="bi bi-trash"></i> 删除';
          delBtn.addEventListener('click', async () => {
            if(confirm('确定要删除这个UUID吗？')) {
              const originalText = delBtn.innerHTML;
              delBtn.disabled = true;
              delBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>删除中...';

              if (currentUuidSource === 'local') {
                // 本地操作
                await fetch(`/api/uuid/${item.uuid}`,{method:'DELETE'});
              } else {
                // 远程操作
                try {
                  let url = currentUuidSource;
                  if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                  }

                  await fetch(url + '/sync', {
                    method: 'POST',
                    headers: {
                      'Authorization': 'Bearer ' + currentWorkerApikey,
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      action: 'delete',
                      uuid: item.uuid
                    })
                  });
                } catch (error) {
                  alert('删除远程UUID失败: ' + error.message);
                  console.error('Error deleting remote UUID:', error);
                }
              }

              await loadUuidsFromSource();
              delBtn.disabled = false;
              delBtn.innerHTML = originalText;
            }
          });

          li.appendChild(uuidText);
          li.appendChild(statusBtn);
          li.appendChild(delBtn);

          list.appendChild(li);
        });
      }

      // 保留原函数名，但调用新函数
      async function loadUuids() {
        await loadUuidsFromSource();
      }

      // Workers管理功能
      document.getElementById('addWorker').addEventListener('click', async ()=>{
        const url = document.getElementById('newWorkerUrl').value;
        const apikey = document.getElementById('newWorkerApikey').value;
        if(!url || !apikey) {
          return;
        }

        const btn = document.getElementById('addWorker');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>添加中...';

        await fetch('/api/workers',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({workers:url, apikey:apikey, statu:true})});
        document.getElementById('newWorkerUrl').value = '';
        document.getElementById('newWorkerApikey').value = '';
        await loadWorkers();

        btn.disabled = false;
        btn.innerHTML = originalText;
      });

      async function loadWorkers() {
        const r = await fetch('/api/workers');
        if(r.ok) {
          const data = await r.json();
          const list = document.getElementById('workersEditList');
          list.innerHTML = '';

          const rawDiv = document.getElementById('workersRaw');
          rawDiv.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';

          data.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.style.borderRadius = '12px';
            li.style.marginBottom = '8px';
            li.style.border = '1px solid var(--border-color)';

            const container = document.createElement('div');
            container.className = 'd-flex flex-column flex-grow-1 me-2';

            const urlInput = document.createElement('input');
            urlInput.type = 'text';
            urlInput.className = 'form-control mb-1';
            urlInput.value = item.workers;
            urlInput.readOnly = true;

            const apikeyInput = document.createElement('input');
            apikeyInput.type = 'text';
            apikeyInput.className = 'form-control';
            apikeyInput.value = item.apikey;
            apikeyInput.readOnly = true;

            container.appendChild(urlInput);
            container.appendChild(apikeyInput);

            // 创建按钮容器
            const btnContainer = document.createElement('div');
            btnContainer.className = 'd-flex flex-column';

            // 添加状态按钮
            const statusBtn = document.createElement('button');
            statusBtn.className = 'btn btn-sm mb-1 ' + (item.statu ? 'btn-success' : 'btn-outline-secondary');
            statusBtn.innerHTML = '<i class="bi ' + (item.statu ? 'bi-check-circle' : 'bi-x-circle') + '"></i> ' + (item.statu ? '启用' : '禁用');
            statusBtn.addEventListener('click', async () => {
              const originalText = statusBtn.innerHTML;
              statusBtn.disabled = true;
              statusBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>更新中...';

              const newStatus = !item.statu;
              await fetch('/api/worker',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({index:index, statu:newStatus})});
              await loadWorkers();

              statusBtn.disabled = false;
              statusBtn.innerHTML = originalText;
            });

            const delBtn = document.createElement('button');
            delBtn.className = 'btn btn-sm btn-outline-danger';
            delBtn.innerHTML = '<i class="bi bi-trash"></i> 删除';
            delBtn.addEventListener('click', async () => {
              if(confirm('确定要删除这个Worker吗？')) {
                const originalText = delBtn.innerHTML;
                delBtn.disabled = true;
                delBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>删除中...';

                await fetch(`/api/worker/${index}`,{method:'DELETE'});
                await loadWorkers();

                delBtn.disabled = false;
                delBtn.innerHTML = originalText;
              }
            });

            btnContainer.appendChild(statusBtn);
            btnContainer.appendChild(delBtn);

            li.appendChild(container);
            li.appendChild(btnContainer);

            list.appendChild(li);
          });

          // 加载Workers列表到UUID配置页面
          const workersList = document.getElementById('workersList');
          workersList.innerHTML = '';

          // 添加本地UUID选项
          const localLi = document.createElement('li');
          localLi.className = 'list-group-item d-flex justify-content-between align-items-center';
          localLi.style.borderRadius = '12px';
          localLi.style.marginBottom = '8px';
          localLi.style.border = '1px solid var(--border-color)';

          const localLink = document.createElement('span');
          localLink.textContent = '本地UUID';
          localLink.className = 'flex-grow-1';

          const loadLocalBtn = document.createElement('button');
          loadLocalBtn.className = 'btn btn-sm btn-success';
          loadLocalBtn.id = 'loadLocalUuidBtn';
          loadLocalBtn.innerHTML = '<i class="bi bi-download"></i> 载入UUID';
          loadLocalBtn.addEventListener('click', async () => {
            await loadLocalUuids();
          });

          localLi.appendChild(localLink);
          localLi.appendChild(loadLocalBtn);
          workersList.appendChild(localLi);

          // 添加分隔线
          const divider = document.createElement('div');
          divider.className = 'dropdown-divider';
          workersList.appendChild(divider);

          // 只显示启用的workers
          const enabledWorkers = data.filter(item => item.statu);

          enabledWorkers.forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.style.borderRadius = '12px';
            li.style.marginBottom = '8px';
            li.style.border = '1px solid var(--border-color)';

            const link = document.createElement('span');
            link.textContent = item.workers;
            link.className = 'flex-grow-1';

            // 创建按钮容器
            const btnContainer = document.createElement('div');
            btnContainer.className = 'd-flex gap-1';

            // 修改同步按钮
            const syncBtn = document.createElement('button');
            syncBtn.className = 'btn btn-sm btn-primary';
            syncBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> 同步UUID';
            syncBtn.addEventListener('click', async () => {
              const originalText = syncBtn.innerHTML;
              syncBtn.disabled = true;
              syncBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>同步中...';

              await fetch('/api/sync_uuid',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({workerURL:item.workers})
              });

              syncBtn.disabled = false;
              syncBtn.innerHTML = originalText;
            });

            // 添加载入UUID按钮
            const loadBtn = document.createElement('button');
            loadBtn.className = 'btn btn-sm btn-success';
            loadBtn.innerHTML = '<i class="bi bi-download"></i> 载入UUID';
            loadBtn.addEventListener('click', async () => {
              const originalText = loadBtn.innerHTML;
              loadBtn.disabled = true;
              loadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>载入中...';

              try {
                console.log('点击载入UUID按钮，worker URL:', item.workers);
                console.log('API Key:', item.apikey ? '已设置' : '未设置');

                await loadRemoteUuids(item.workers, item.apikey);

                // 更新按钮状态 - 确保只有一个载入源
                document.querySelectorAll('#workersList button').forEach(btn => {
                  if (btn.id !== 'loadLocalUuidBtn' && btn.innerHTML.includes('载入UUID') || btn.innerHTML.includes('已载入源')) {
                    btn.innerHTML = '<i class="bi bi-download"></i> 载入UUID';
                    btn.classList.remove('btn-warning');
                    btn.classList.add('btn-success');
                  }
                });

                loadBtn.innerHTML = '<i class="bi bi-download"></i> 已载入源';
                loadBtn.classList.remove('btn-success');
                loadBtn.classList.add('btn-warning');
              } catch (error) {
                console.error('载入UUID失败:', error);
                alert('载入UUID失败: ' + error.message);
                loadBtn.innerHTML = originalText;
              }

              loadBtn.disabled = false;
            });

            btnContainer.appendChild(syncBtn);
            btnContainer.appendChild(loadBtn);

            li.appendChild(link);
            li.appendChild(btnContainer);

            workersList.appendChild(li);
          });
        }
      }

      // 日志显示功能
      const logbox = document.getElementById('logbox');
      const maxLogLines = 100;

      // 使用WebSocket连接服务器获取实时日志
      let eventSource;

      function connectLogStream() {
        if (eventSource) {
          eventSource.close();
        }

        eventSource = new EventSource('/api/logs/stream');
        eventSource.onmessage = function(event) {
          const newLog = event.data;
          logbox.textContent += newLog + '\n';

          // 限制日志行数
          const lines = logbox.textContent.split('\n');
          if (lines.length > maxLogLines) {
            logbox.textContent = lines.slice(-maxLogLines).join('\n');
          }

          // 自动滚动到底部
          logbox.scrollTop = logbox.scrollHeight;
        };

        eventSource.onerror = function() {
          logbox.textContent += '日志连接错误，正在重试...\n';
          setTimeout(connectLogStream, 3000);
        };
      }

      // 清空日志按钮
      document.getElementById('clearLogs').addEventListener('click', () => {
        logbox.textContent = '';
      });

      // CDN Domain管理功能
      document.getElementById('addCdnDomain').addEventListener('click', async ()=>{
        const domain = document.getElementById('newCdnDomain').value;
        const option = document.getElementById('newCdnDomainOption').value;
        if(!domain) {
          return;
        }

        const btn = document.getElementById('addCdnDomain');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>添加中...';

        await fetch('/api/cdndomains',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({domain:domain, option:option})
        });

        document.getElementById('newCdnDomain').value = '';
        document.getElementById('newCdnDomainOption').value = '';
        await loadCdnDomains();

        btn.disabled = false;
        btn.innerHTML = originalText;
      });

      // 加载CDN域名列表
      async function loadCdnDomains() {
        const r = await fetch('/api/cdndomains');
        if(r.ok) {
          const data = await r.json();
          const list = document.getElementById('cdnDomainList');
          list.innerHTML = '';

          data.forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.style.borderRadius = '12px';
            li.style.marginBottom = '8px';
            li.style.border = '1px solid var(--border-color)';

            // 创建容器用于显示域名和备注
            const container = document.createElement('div');
            container.className = 'd-flex flex-column flex-grow-1 me-2';

            const domainText = document.createElement('span');
            domainText.className = 'mb-1';
            domainText.textContent = item.domain;

            // 只有当option存在时才创建optionText
            if (item.option) {
              const optionText = document.createElement('small');
              optionText.className = 'text-muted';
              optionText.textContent = item.option;
              container.appendChild(domainText);
              container.appendChild(optionText);
            } else {
              container.appendChild(domainText);
            }

            const delBtn = document.createElement('button');
            delBtn.className = 'btn btn-sm btn-outline-danger';
            delBtn.innerHTML = '<i class="bi bi-trash"></i> 删除';
            delBtn.addEventListener('click', async () => {
              if(confirm('确定要删除这个CDN域名吗？')) {
                const originalText = delBtn.innerHTML;
                delBtn.disabled = true;
                delBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>删除中...';

                await fetch(`/api/cdndomain/${item.domain}`,{method:'DELETE'});
                await loadCdnDomains();

                delBtn.disabled = false;
                delBtn.innerHTML = originalText;
              }
            });

            li.appendChild(container);
            li.appendChild(delBtn);

            list.appendChild(li);
          });
        }
      }

      // 初始化加载数据
      loadData();
      loadWorkers();
      loadCdnIp();
      // 确保正确初始化Proxy数据
      setActiveProxyButton('proxyIpBtn');
      currentProxyType = 'ip';
      loadProxyData();
      loadCdnDomains();

      // 等待workers加载完成后，再加载本地UUID
      setTimeout(() => {
        loadLocalUuids();
      }, 500);

      // 连接日志流
      connectLogStream();

      // 定时更新下次执行时间
      // 初始加载时更新一次
      updateNextRunTime();

      // 根据cron表达式设置更新频率
      function scheduleNextUpdate() {
        fetch('/api/get_cron_next')
          .then(response => response.json())
          .then(data => {
            if (data.next_run_timestamp > 0) {
              const now = Math.floor(Date.now() / 1000);
              const nextUpdate = data.next_run_timestamp;

              // 计算距离下次执行的秒数
              const secondsUntilNext = nextUpdate - now;

              // 如果距离下次执行超过60秒，则每60秒更新一次
              // 否则，在下次执行时间点更新
              if (secondsUntilNext > 60) {
                setTimeout(() => {
                  updateNextRunTime();
                  scheduleNextUpdate(); // 递归调用，重新计算下次更新时间
                }, 60000);
              } else {
                setTimeout(() => {
                  updateNextRunTime();
                  scheduleNextUpdate(); // 递归调用，重新计算下次更新时间
                }, secondsUntilNext * 1000);
              }
            } else {
              // 如果获取失败，则每60秒更新一次
              setTimeout(() => {
                updateNextRunTime();
                scheduleNextUpdate(); // 递归调用，重新计算下次更新时间
              }, 60000);
            }
          })
          .catch(error => {
            console.error('获取下次执行时间失败:', error);
            // 出错时每60秒更新一次
            setTimeout(() => {
              updateNextRunTime();
              scheduleNextUpdate(); // 递归调用，重新计算下次更新时间
            }, 60000);
          });
      }

      // 启动动态更新调度
      scheduleNextUpdate();
    </script>
  </body>
</html>